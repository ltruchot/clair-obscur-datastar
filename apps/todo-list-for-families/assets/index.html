<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script
      type="module"
      src="https://cdn.jsdelivr.net/gh/starfederation/datastar@1.0.0-RC.5/bundles/datastar.js"></script>

    <link rel="stylesheet" href="/main.css" />

    <script type="module" src="/list-of-items.js"></script>
    <link rel="stylesheet" href="/list-of-items.css" />

    <script type="module" src="/count-down.js"></script>
    <link rel="stylesheet" href="/count-down.css" />

    <title>Todo List</title>
  </head>
  <body data-on-load="@get('/subscribe-to-events')">
    <main class="flex-between">
      <section>
        <!-- Pretty title -->
        <h1 class="rainbow">Todo List For Big Families</h1>

        <!-- Forms inputs to create/remove todos -->
        <input id="todo" maxlength="80" data-bind-todo />

        <button
          id="add-todo"
          data-on-click="@post('/add-todo')
            $todo='';
            focusTo('todo')"
          data-attr-disabled="$todo.length === 0">
          Add
        </button>

        <button
          data-attr-disabled="$todos ? $todos.filter((todo) => todo.checked).length === 0 : true"
          data-on-click="$shouldClearDoneOnly = true; @post('/clear')">
          Clear Done
        </button>

        <button
          data-attr-disabled="$todos ? $todos?.length === 0 : true"
          data-on-click="$shouldClearDoneOnly = false; @post('/clear')">
          Clear All
        </button>

        <!-- Todo statistics -->
        <table class="stats-table">
          <tr>
            <th>Todo</th>
            <th>Done</th>
          </tr>
          <tr>
            <td data-text="$todos ? $todos.filter((todo) => !todo.checked).length : 0"></td>
            <td data-text="$todos ? $todos.filter((todo) => todo.checked).length : 0"></td>
          </tr>
        </table>
        <count-down data-attr-seconds-left="$secondsLeft"></count-down>

        <!-- List of todos -->
        <list-of-items
          id="todos"
          data-attr-items="$todos || []"
          data-on-item-toggle="
            $updatedTodo = { id: event.detail.id,label: event.detail.label, checked: event.detail.checked };
            @post('/update-todo');">
        </list-of-items>
      </section>

      <!-- Debug todos state as raw JSON on the right side -->
      <pre style="max-width: 50%">
<code data-text="JSON.stringify($todos, null, 2)"></code>
      </pre>
    </main>

    <!-- Links to GitHub and DataStar -->
    <a
      href="https://github.com/ltruchot/clair-obscur-datastar/tree/main/apps/todo-list-for-families"
      class="github-icon">
      <img src="/github.svg" alt="GitHub" />
    </a>
    <a href="https://data-star.dev" class="datastar-icon">
      <img src="/datastar.png" alt="DataStar" />
    </a>

    <script>
      // Convenience functions
      function byId(id) {
        return document.getElementById(id);
      }

      function focusTo(id) {
        byId(id).focus();
      }

      // press [Enter] while focus on input will trigger "add todo" button
      document.body.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && byId('add-todo').disabled === false && byId('todo').matches(':focus')) {
          byId('add-todo').click();
        }
      });
    </script>
  </body>
</html>
